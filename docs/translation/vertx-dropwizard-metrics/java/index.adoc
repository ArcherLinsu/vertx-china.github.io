= Metrics

本项目基于 https://github.com/dropwizard/metrics[Dropwizard metrics]
实现了 Vert.x 指标监控的SPI（Service Provider Interface，服务供应接口）。

[[_features]]
== 特性

Vert.x 提供了一个相当易用的API接口 `link:../../apidocs/io/vertx/core/metrics/Measured.html[Measured]` ，用于查询监控指标，
很多 Vert.x 组件都实现了这个接口，包括 `link:../../apidocs/io/vertx/core/http/HttpServer.html[HttpServer]`，
`link:../../apidocs/io/vertx/core/net/NetServer.html[NetServer]`，以及 `link:../../apidocs/io/vertx/core/Vertx.html[Vertx]` 本身等等。

本项目基于 Dropwizard 实现了可配置的 JMX 上报服务，可将 Vert.x 作为 JMX 的 MBean 使用。

== 入门

使用 Vert.x 指标监控需要在您项目的构建配置增加以下 _依赖_ ：

* Maven（位于 `pom.xml`）：

[source,xml,subs="+attributes"]
----
<dependency>
 <groupId>io.vertx</groupId>
 <artifactId>vertx-dropwizard-metrics</artifactId>
 <version>4.0.2</version>
</dependency>
----

* Gradle（位于 `build.gradle`）：

[source,groovy,subs="+attributes"]
----
compile 'io.vertx:vertx-dropwizard-metrics:4.0.2'
----

创建 Vertx 实例时通过 `link:../../apidocs/io/vertx/ext/dropwizard/DropwizardMetricsOptions.html[DropwizardMetricsOptions]` 启用指标监控：

[source,java]
----
Vertx vertx = Vertx.vertx(new VertxOptions().setMetricsOptions(
    new DropwizardMetricsOptions().setEnabled(true)
));
----

也可以启用 JMX 支持：

[source,java]
----
Vertx vertx = Vertx.vertx(new VertxOptions().setMetricsOptions(
    new DropwizardMetricsOptions().setJmxEnabled(true)
));
----

更多关于 JMX 的信息请参阅文末的 <<jmx>> 章节。

[[_command_line_activation]]
== 命令行模式激活指标监控

在命令行模式（Vert.x CLI）启动的 Vert.x 应用可以通过 JVM 系统属性启用指标监控。
_vertx.metrics.options._ 开头的系统属性会被传递到指标监控的配置。

_vertx.metrics.options.enabled_ 是一个标准 Vert.x Core 配置，用于启用指标监控，
（欲启用指标监控）此选项必须设置为 `true` ：

----
java -jar your-fat-jar -Dvertx.metrics.options.enabled=true
----

`link:../../apidocs/io/vertx/ext/dropwizard/DropwizardMetricsOptions.html#setRegistryName-java.lang.String-[vertx.metrics.options.registryName]`
配置项用于设置要使用的（现存的） <<dropwizard-registry,Dropwizard Registry>> ：

----
java -jar your-fat-jar -Dvertx.metrics.options.enabled=true -Dvertx.metrics.options.registryName=my-registry
----

`link:../../apidocs/io/vertx/ext/dropwizard/DropwizardMetricsOptions.html#setJmxEnabled-boolean-[vertx.metrics.options.jmxEnabled]` 和
`link:../../apidocs/io/vertx/ext/dropwizard/DropwizardMetricsOptions.html#setJmxDomain-java.lang.String-[vertx.metrics.options.jmxDomain]`
配置项用于配置 <<jmx,JMX>> 注册信息：

----
java -jar your-fat-jar -Dvertx.metrics.options.enabled=true -Dvertx.metrics.options.jmxEnabled=true ...
----

`link:../../apidocs/io/vertx/ext/dropwizard/DropwizardMetricsOptions.html#setConfigPath-java.lang.String-[vertx.metrics.options.configPath]`
配置项用于从指定的配置文件读取指标监控配置。

[[_metrics_service]]
== 指标监控服务

Vert.x core 定了了上报监控指标的 SPI （本项目已实现），
但并没有定义读取监控指标的 API （因为某些指标监控的实现只上报监控指标，不做其他事情）。

`link:../../apidocs/io/vertx/ext/dropwizard/MetricsService.html[MetricsService]` 封装了 Dropwizard Registry，
提供了获取监控指标快照（snapshot）的API。

[[_naming]]
=== 监控指标命名

下面列出的每个可监控组件（Vertx除外）都有与之关联的基本指标名（baseName，译者注：即指标名的前缀）。
所有监控指标都可以通过 Vertx 对象，使用全限定指标名 <fqn> （`baseName` + `.` + `metricName`）获取。

[source,java]
----
JsonObject metrics = metricsService.getMetricsSnapshot(vertx);
metrics.getJsonObject("vertx.eventbus.handlers");
----

或者通过要监控的组件对象，使用指标名（`metricName`）获取监控指标：

[source,java]
----
EventBus eventBus = vertx.eventBus();
JsonObject metrics = metricsService.getMetricsSnapshot(eventBus);
metrics.getJsonObject("handlers");
----

更多关于从指定组件对象获取/使用监控指标的例子，请参见下文。

您可以可以列出所有监控指标名：

[source,java]
----
Set<String> metricsNames = metricsService.metricsNames();
for (String metricsName : metricsNames) {
  System.out.println("Known metrics name " + metricsName);
}
----

基本指标名（`baseName`） 默认是 `vertx`，但也可以自定义一个基本指标名：

[source,java]
----
DropwizardMetricsOptions metricsOptions =
  new DropwizardMetricsOptions().setBaseName("foo");
----

[[_retrieving_metrics]]
=== 获取监控指标

启用指标监控后， `link:../../apidocs/io/vertx/ext/dropwizard/MetricsService.html[MetricsService]` 可以从
`link:../../apidocs/io/vertx/core/metrics/Measured.html[Measured]` 实例获取监控指标的快照（snapshot）；
快照是一个键为指标名、值为指标值的 `link:../../apidocs/io/vertx/core/json/JsonObject.html[JsonObject]` 对象。
下面的例子打印了 Vertx 实例所有的监控指标（快照）：
[source,java]
----
MetricsService metricsService = MetricsService.create(vertx);
JsonObject metrics = metricsService.getMetricsSnapshot(vertx);
System.out.println(metrics);
----

NOTE: 有关 `link:../../apidocs/io/vertx/core/json/JsonObject.html[JsonObject]` 快照实例包含的实际内容（实际监控指标）详情，
请参阅具体指标实现的文档，如 https://github.com/vert-x3/vertx-metrics[vertx-metrics]

通常您只需获取特定组件（例如 http 服务器）的特定指标，
而不必知道每个指标的命名细节（留给 SPI 的实现处理）。

`link:../../apidocs/io/vertx/core/http/HttpServer.html[HttpServer]` 实现了 `link:../../apidocs/io/vertx/core/metrics/Measured.html[Measured]`，
因此您可以轻松获取到指定 http 服务器的所有监控指标。

[source,java]
----
MetricsService metricsService = MetricsService.create(vertx);
HttpServer server = vertx.createHttpServer();
// 设置 HTTP 服务器
JsonObject metrics = metricsService.getMetricsSnapshot(server);
----

使用基本指标名（baseName）也可以获取到监控指标：

[source,java]
----
MetricsService metricsService = MetricsService.create(vertx);
JsonObject metrics = metricsService.getMetricsSnapshot("vertx.eventbus.message");
----

[[_data]]
== 指标数据

下面是（快照）JSON 中的所有 dropwizard 监控指标。
每个监控指标的详情请参阅 https://github.com/dropwizard/metrics[Dropwizard metrics] 文档。

[[gauge]]
=== 测量值

[source,javascript]
----
{
 "type"  : "gauge",
 "value" : value // 任一json值（译者注：数字、字符串、数组、对象等）
}
----

[[counter]]
=== 计数器

[source,java]
----
{
 "type"  : "counter",
 "count" : 1 // 数字
}
----

[[histogram]]
=== 柱状图

[source,javascript]
----
{
 "type"   : "histogram",
 "count"  : 1 // long
 "min"    : 1 // long
 "max"    : 1 // long
 "mean"   : 1.0 // double
 "stddev" : 1.0 // double
 "median" : 1.0 // double
 "75%"    : 1.0 // double
 "95%"    : 1.0 // double
 "98%"    : 1.0 // double
 "99%"    : 1.0 // double
 "99.9%"  : 1.0 // double
}
----

[[meter]]
=== 仪表（Meter）

[source,java]
----
{
 "type"              : "meter",
 "count"             : 1 // long
 "meanRate"          : 1.0 // double
 "oneMinuteRate"     : 1.0 // double
 "fiveMinuteRate"    : 1.0 // double
 "fifteenMinuteRate" : 1.0 // double
 "rate"              : "events/second" // 速率，字符串
}
----

[[throughput_meter]]
=== 吞吐量统计

即时吞吐量统计，扩展自 <<meter,仪表>> 。

[source,java]
----
{
 "type"              : "meter",
 "count"             : 40 // long
 "meanRate"          : 2.0 // double
 "oneSecondRate"     : 3 // long - 最近一秒的取值
 "oneMinuteRate"     : 1.0 // double
 "fiveMinuteRate"    : 1.0 // double
 "fifteenMinuteRate" : 1.0 // double
 "rate"              : "events/second" // 速率，字符串
}
----

[[timer]]
=== 计时器

A timer is basically a combination of Histogram + Meter.

[source,java]
----
{
 "type": "timer",

 // 柱状图数据
 "count"  : 1 // long
 "min"    : 1 // long
 "max"    : 1 // long
 "mean"   : 1.0 // double
 "stddev" : 1.0 // double
 "median" : 1.0 // double
 "75%"    : 1.0 // double
 "95%"    : 1.0 // double
 "98%"    : 1.0 // double
 "99%"    : 1.0 // double
 "99.9%"  : 1.0 // double

 // 仪表（meter）数据
 "meanRate"          : 1.0 // double
 "oneMinuteRate"     : 1.0 // double
 "fiveMinuteRate"    : 1.0 // double
 "fifteenMinuteRate" : 1.0 // double
 "rate"              : "events/second" // 速率，字符串
}
----

[[throughput_timer]]
=== 吞吐量计时器

扩展了 <<timer,计时器>> ，可提供即时吞吐量指标。

[source,java]
----
{
 "type": "timer",

 // 柱状图数据
 "count"      : 1 // long
 "min"        : 1 // long
 "max"        : 1 // long
 "mean"       : 1.0 // double
 "stddev"     : 1.0 // double
 "median"     : 1.0 // double
 "75%"        : 1.0 // double
 "95%"        : 1.0 // double
 "98%"        : 1.0 // double
 "99%"        : 1.0 // double
 "99.9%"      : 1.0 // double

 // 仪表（meter）数据
 "meanRate"          : 1.0 // double
 "oneSecondRate"     : 3 // long - 最近一秒的取值
 "oneMinuteRate"     : 1.0 // double
 "fiveMinuteRate"    : 1.0 // double
 "fifteenMinuteRate" : 1.0 // double
 "rate"              : "events/second" // 速率，字符串
}
----

[[_the_metrics]]
== 监控指标

Vert.x 目前提供以下指标。

[[_vertx_metrics]]
=== Vert.x 指标

目前提供以下指标：

* `vertx.event-loop-size` - 类型：<<gauge,测量值>>，含义：event-loop 线程池的线程数量
* `vertx.worker-pool-size` - 类型：<<gauge,测量值>>，含义：worker-pool 线程池的线程数量
* `vertx.cluster-host` - 类型：<<gauge,测量值>>，含义：cluster-host 配置值
* `vertx.cluster-port` - 类型：<<gauge,测量值>>，含义：cluster-port 配置值

[[_event_bus_metrics]]
=== Event bus 指标

基本指标名（baseName）： `vertx.eventbus`

* `handlers` - 类型：<<counter,计数器>>，含义：eventbus 中已注册的处理器数量
* `handlers.myaddress` - 类型：<<timer>>，含义：名为 _myaddress_ 的处理器处理消息的速率
* `messages.bytes-read` - 类型：<<meter>>，含义：接收到的远程消息总字节量
* `messages.bytes-written` - 类型：<<meter>>，含义：发送到远程地址的消息总字节量
* `messages.pending` - 类型：<<counter>>，含义：已经被 eventbus 接收，但是还未被处理器所处理的消息数。
* `messages.pending-local` - 类型：<<counter>>，含义：已经被本地 eventbus 接收，但是还未被处理器所处理的消息数。
* `messages.pending-remote` - 类型：<<counter>>，含义：已经被远程 eventbus 接收，但是还未被处理器所处理的消息数。
* `messages.discarded` - 类型：<<counter>>，含义：已被处理器丢弃的消息数
* `messages.discarded-local` - 类型：<<counter>>，含义：已被本地处理器丢弃的消息数
* `messages.discarded-remote` - 类型：<<counter>>，含义：已被远程处理器丢弃的消息数
* `messages.received` - 类型：<<throughput_meter>>，含义：接受消息的速率
* `messages.received-local` - 类型：<<throughput_meter>>，含义：接受本地消息的速率
* `messages.received-remote` - 类型：<<throughput_meter>>，含义：接受远程消息的速率
* `messages.delivered` - 类型：<<throughput_meter>>，含义：消息被传递到处理器的速率
* `messages.delivered-local` - 类型：<<throughput_meter>>，含义：本地消息被传递到处理器的速率
* `messages.delivered-remote` - 类型：<<throughput_meter>>，含义：远程消息被传递到处理器的速率
* `messages.sent` - 类型：<<throughput_metert>>，含义：发送消息的速率
* `messages.sent-local` - 类型：<<throughput_meter>>，含义：本地发送消息的速率
* `messages.sent-remote` - 类型：<<throughput_meter>>，含义：远程发送消息的速率
* `messages.published` - 类型：<<throughput_meter>>，含义：发布消息的速率
* `messages.published-local` - 类型：<<throughput_meter>>，含义：本地发布消息的速率
* `messages.published-remote` - 类型：<<throughput_meter>>，含义：远程发布消息的速率
* `messages.reply-failures` - 类型：<<meter>>，含义：回复消息失败的速率

可以通过在处理程序注册地址上执行的匹配来配置受监视的事件总线处理程序。
Vert.x可能具有大量已注册的事件总线，因此，此设置的唯一好默认设置是监视零处理程序。
The monitored event bus handlers is configurable via a match performed on the handler registration address.
Vert.x can have potentially a huge amount of registered event bus, therefore the only good default for this
setting is to monitor zero handlers.

The monitored handlers can be configured in the `link:../../apidocs/io/vertx/ext/dropwizard/DropwizardMetricsOptions.html[DropwizardMetricsOptions]` via
a specific address match or a regex match:

[source,java]
----
Vertx vertx = Vertx.vertx(new VertxOptions().setMetricsOptions(
    new DropwizardMetricsOptions().
        setEnabled(true).
        addMonitoredEventBusHandler(
            new Match().setValue("some-address")).
        addMonitoredEventBusHandler(
            new Match().setValue("business-.*").setType(MatchType.REGEX))
));
----

WARNING: 使用正则匹配时，错误的正则表达式可能会匹配上很多处理器。

[[http-server-metrics]]
=== Http server 指标

基本指标名（baseName）： `vertx.http.servers.<host>:<port>`

Http 服务器的指标包括 <<net-server-metrics,Net 服务>> 的所有指标以及以下内容：

* `requests` - 类型：<<throughput_timer>>，含义：单个请求及其出现的频率
* `<http-method>-requests` - 类型：<<throughput_timer>>，含义：指定 HTTP 方法（译者注：由 <http-method> 指定）的请求及其频率。
** 例如： `get-requests`， `post-requests`
* `<http-method>-requests./<uri>` - 类型：<<throughput_timer>>，含义：指定 HTTP 方法和 URI 的请求及其频率。
** 例如： `get-requests./some/uri`， `post-requests./some/uri?foo=bar`
* `<http-method>-requests./<route>` - 类型：<<throughput_timer>>，含义：指定 HTTP 方法和路由的请求及其频率。
** 例如： `get-requests./route1`, `post-requests./resource/:id`
* `responses-1xx` - 类型：<<throughput_meter>>，含义：1xx响应的频次
* `responses-2xx` - 类型：<<throughput_meter>>，含义：2xx响应的频次
* `responses-3xx` - 类型：<<throughput_meter>>，含义：3xx响应的频次
* `responses-4xx` - 类型：<<throughput_meter>>，含义：4xx响应的频次
* `responses-5xx` - 类型：<<throughput_meter>>，含义：5xx响应的频次
* `open-websockets` - 类型：<<counter>>，含义：打开的网络套接字连接数量
* `open-websockets.<remote-host>` - 类型：<<counter>>，含义：连接到指定远程主机（译者注：由 <remote-host> 指定）所打开网络套接字的连接数量

Http URI 指标必须在 MetricsOptions 中显式配置，可以使用完全匹配或正则表达式匹配：

[source,java]
----
Vertx vertx = Vertx.vertx(new VertxOptions().setMetricsOptions(
    new DropwizardMetricsOptions().
        setEnabled(true).
        addMonitoredHttpServerUri(
            new Match().setValue("/")).
        addMonitoredHttpServerUri(
            new Match().setValue("/foo/.*").setType(MatchType.REGEX))
));
----

In case if the uri contains some path parameters like `/users/:userId` it might not make sense to have a separate entry in the registry for each user
id (like `get-requests./users/1`, `get-requests./users/2` and so on) but a summarized one. To achieve that you can set an alias to the match instance
in this case the alias will be used as a part of the registry name instead of uri like `<http-method>-requests.<alias>`.
In addition there will be separate counters for each response group for each defined alias like `responses-<code>.<alias>`.

[source,java]
----
Vertx vertx = Vertx.vertx(new VertxOptions().setMetricsOptions(
    new DropwizardMetricsOptions().
        setEnabled(true).
        addMonitoredHttpServerUri(new Match().setValue("/users/.*").setAlias("users").setType(MatchType.REGEX))
));
----

Http request routes can be reported by frameworks like vertx-web per request, i.e. core vert.x doesn't report any route information by itself. Like URI
metrics, route metrics must be configured explicitly in the options:

[source,java]
----
Vertx vertx = Vertx.vertx(new VertxOptions().setMetricsOptions(
  new DropwizardMetricsOptions().
    setEnabled(true).
    addMonitoredHttpServerRoute(new Match().setValue("/users/.*").setType(MatchType.REGEX))
));
----

Similar to URI metrics it is possible to provide aliases but usually routes itself provide sufficient and appropriate semantic grouping of URIs. Note
that a single http request can be routed multiple times (for example because of vertx-web sub routers) and all reported routes per request will be
joined together with `>` (for example `/internal_api>/resource/:id`)

*For `bytes-read` and `bytes-written` the bytes represent the body of the request/response, so headers, etc are ignored.*

[[_http_client_metrics]]
=== Http 客户端指标

基本指标名（baseName）： `vertx.http.clients` （默认），或 `vertx.http.clients.<id>` ，其中 `<id>` 是由
`link:../../apidocs/io/vertx/core/http/HttpClientOptions.html#setMetricsName-java.lang.String-[setMetricsName]` 设置的非空字符串。

Http 客户端的指标包括 <<http-server-metrics,Http 服务>> 的所有指标以及下述指标：

* `connections.max-pool-size` - 类型：<<gauge>>，含义：连接池规模
* `connections.pool-ratio` - 类型：ratio <<gauge>>，含义：已打开的连接与连接池规模的比率
* `responses-1xx` - 类型：<<meter>>，含义：1xx响应码
* `responses-2xx` - 类型：<<meter>>，含义：2xx响应码
* `responses-3xx` - 类型：<<meter>>，含义：3xx响应码
* `responses-4xx` - 类型：<<meter>>，含义：4xx响应码
* `responses-5xx` - 类型：<<meter>>，含义：5xx响应码

The http client manages a pool of connection for each remote endpoint with a queue of pending requests

Endpoint metrics are available too:

* `endpoint.<host:port>.queue-delay` - 类型：<<timer>>，含义：of the wait time of a pending request in the queue
* `endpoint.<host:port>.queue-size` - 类型：<<counter>>，含义：of the actual queue size
* `endpoint.<host:port>.open-netsockets` - 类型：<<counter>>，含义：of the actual number of open sockets to the endpoint
* `endpoint.<host:port>.usage` - 类型：<<timer>>，含义：of the delay between the request starts and the response ends
* `endpoint.<host:port>.in-use` - 类型：<<counter>>，含义：of the actual number of request/response
* `endpoint.<host:port>.ttfb` - 类型：<<timer>>，含义：of the wait time between the request ended and its response begins

where <host> is the endpoint host name possibly unresolved and <port> the TCP port.

The monitored endpoints are configurable via a match performed on the server `$host:$port`.
The default for this setting is to monitor no endpoints.

The monitored endpoints can be configured in the `link:../../apidocs/io/vertx/ext/dropwizard/DropwizardMetricsOptions.html[DropwizardMetricsOptions]` via
a specific hostname match or a regex match:

[source,java]
----
Vertx vertx = Vertx.vertx(new VertxOptions().setMetricsOptions(
    new DropwizardMetricsOptions().
        setEnabled(true).
        addMonitoredHttpClientEndpoint(
            new Match().setValue("some-host:80")).
        addMonitoredHttpClientEndpoint(
            new Match().setValue("another-host:.*").setType(MatchType.REGEX))
));
----

[[net-server-metrics]]
=== Net 服务指标

基本指标名（baseName）： `vertx.net.servers.<host>:<port>`

* `open-netsockets` - 类型：<<counter>>，含义：打开 net 套接字的连接数
* `open-netsockets.<remote-host>` - 类型：<<counter>>，含义：连接到指定远程主机所打开的 net 套接字连接数
* `connections` - 类型：<<timer>>，含义：连接及其创建频率
* `exceptions` - 类型：<<counter>>，含义：出现异常的次数
* `bytes-read` - 类型：<<counter>>，含义：读取的字节数
* `bytes-written` - 类型：<<counter>>，含义：写入的字节数

[[_net_client_metrics]]
=== Net 客户端指标

基本指标名（baseName）： `vertx.net.clients`（默认）， 或 `vertx.net.clients.<id>` ，其中 `<id>` 是
`link:../../apidocs/io/vertx/core/net/NetClientOptions.html#setMetricsName-java.lang.String-[setMetricsName]` 配置的非空字符串。

Net 客户端的指标包括 <<net-server-metrics,Net 服务>> 的所有指标。

[[_client_metrics]]
=== 客户端指标

基本指标名（baseName）： `vertx.<type>.clients` (by default) or `vertx.<type>.clients.<id>` where `<id>` is an identifier
for client metrics and <type> is the type of metrics.

The type for SQL client is `sql` and the identifier is the `metricsName` defined by the client options.

Client includes the following:

* `endpoint.<host:port>.requests` - 类型：<<timer>>，含义：of the requests latencies
* `endpoint.<host:port>.queue-delay` - 类型：<<timer>>，含义：of the wait time of a pending request in the queue
* `endpoint.<host:port>.queue-size` - 类型：<<counter>>，含义：of the actual queue size
* `endpoint.<host:port>.in-use` - 类型：<<counter>>，含义：of the actual number of request/response
* `endpoint.<host:port>.ttfb` - 类型：<<timer>>，含义：of the wait time between the request ended and its response begins

=== Datagram socket metrics

基本指标名（baseName）： `vertx.datagram`

* `sockets` - 类型：<<counter>>，含义：of the number of datagram sockets
* `exceptions` - 类型：<<counter>>，含义：of the number of exceptions
* `bytes-written` - 类型：<<counter>>，含义：of the number of bytes written.
* `<host>:<port>.bytes-read` - 类型：<<counter>>，含义：of the number of bytes read.
** This metric will only be available if the datagram socket is listening

[[_pool_metrics]]
=== 池的指标

基本指标名（baseName）： `vertx.pools.<type>.<name>` 。其中 `type` 是池类型（如 _worker_， _datasource_），
`name` 是池的名字（如 `vert.x-worker-thread` ）。

用于运行阻塞任务的工作线程池类型为 _worker_ 。Vert.x将其用于 _vert.x-worker-thread_ 线程和
_vert.x-internal-blocking_ 线程。名为 worker 的执行线程都是由 `link:../../apidocs/io/vertx/core/WorkerExecutor.html[WorkerExecutor]` 创建的。

Vert.x JDBC客户端创建的数据源使用的池名为 _datasource_。

* `queue-delay` - 类型：<<timer>>，含义：获取某个资源的等待时间，例如在队列中的等待时间。
* `queue-size` - 类型：<<counter>>，含义：在队列中等待的资源数
* `usage` - 类型：<<timer>>，含义：某个资源被持续使用的时间
* `in-use` - 类型：<<count>>，含义：使用资源的实际数量
* `pool-ratio` - A ratio <<gauge>>，含义：已使用的资源和池规模的比率
* `max-pool-size` - 类型：<<gauge>>，含义：池的最大规模

当池没有声明最大规模时，`pool-ratio` 和 `max_pool_size`
将没有任何数据。

[[jmx]]
== JMX

JMX 默认禁用。

使用 JMX 需要手动启用，如下：

[source,java]
----
Vertx vertx = Vertx.vertx(new VertxOptions().setMetricsOptions(
    new DropwizardMetricsOptions().setJmxEnabled(true)
));
----

If running Vert.x from the command line you can enable metrics and JMX by uncommented the JMX_OPTS line in the
`vertx` or `vertx.bat` script:

----
JMX_OPTS="-Dcom.sun.management.jmxremote -Dvertx.metrics.options.jmxEnabled=true"
----

You can configure the domain under which the MBeans will be created:

[source,java]
----
Vertx vertx = Vertx.vertx(new VertxOptions().setMetricsOptions(
    new DropwizardMetricsOptions().
        setJmxEnabled(true).
        setJmxDomain("mydomain")
));
----

In the command line, just append the following system properties to your application (works for the `vertx` cli and
fat jars):

[source]
----
-Dvertx.metrics.options.jmxEnabled=true -Dvertx.metrics.options.jmxDomain=vertx
----

== Enabling remote JMX

If you want the metrics to be exposed remotely over JMX, then you need to set, at minimum the following system property:

`com.sun.management.jmxremote`

If running from the command line this can be done by editing the `vertx` or `vertx.bat` and uncommenting the
`JMX_OPTS` line.

Please see the http://docs.oracle.com/javase/8/docs/technotes/guides/management/agent.html[Oracle JMX documentation] for more information on configuring JMX

*If running Vert.x on a public server please be careful about exposing remote JMX access*

[[dropwizard-registry]]
== Accessing Dropwizard Registry

When configuring the metrics service, an optional registry name can be specified for registering the underlying
https://dropwizard.github.io/metrics/3.1.0/getting-started/#the-registry[Dropwizard Registry] in the
the https://dropwizard.github.io/metrics/3.1.0/apidocs/com/codahale/metrics/SharedMetricRegistries.html[Dropwizard Shared Registry]
so you can retrieve this registry and use according to your needs.

[source,java]
----
VertxOptions options = new VertxOptions().setMetricsOptions(
    new DropwizardMetricsOptions().setEnabled(true).setRegistryName("my-registry")
);
Vertx vertx = Vertx.vertx(options);
// Get the registry
MetricRegistry registry = SharedMetricRegistries.getOrCreate("my-registry");}
----

== Using already existing Dropwizard Registry
Optionally, it is possible to utilize already existing https://dropwizard.github.io/metrics/3.1.0/getting-started/#the-registry[Dropwizard Registry].
In order to do so pass `MetricRegistry` instance as parameter for `setMetricRegistry` function in `VertxOptions` object.

[source,java]
----
MetricRegistry metricRegistry = new MetricRegistry();
VertxOptions options = new VertxOptions().setMetricsOptions(
   new DropwizardMetricsOptions().setEnabled(true).setMetricRegistry(metricRegistry)
);
Vertx vertx = Vertx.vertx(options);
----

== Using Jolokia and Hawtio

https://jolokia.org/[Jolokia] is a JMX-HTTP bridge giving an alternative to JSR-160 connectors. It is an agent based
approach with support for many platforms. In addition to basic JMX operations it enhances JMX remoting with features
like bulk requests.

http://hawt.io/[Hawtio] is a modular web console consuming the data exposed by Jolokia. It lets you create dashboards
and retrieve data from JMX such as memory, cpu, or any vert.x metrics.

This section explains how to configure your vert.x application to retrieve the metrics in Hawtio.

First, you need to configure your vert.x instance with the following options:

[source,java]
----
Vertx vertx = Vertx.vertx(new VertxOptions().setMetricsOptions(
    new DropwizardMetricsOptions()
        .setEnabled(true)
        .setJmxEnabled(true)
        .setJmxDomain("vertx-metrics")));
----

You can change the domain to whatever you want. The same configuration can be used for clustered Vert.x instances.
This configuration instructs vertx-dropwizard-metrics to expose the metrics in the local MBean server, so
Jolokia can retrieve them.

Then you need, to _plug_ jolokia to expose the data. There are several ways to _plug_ jolokia. See
https://jolokia.org/reference/html/architecture.html[for further details]. Here, we explain how to use the
Jolokia agent with the default configuration. Refer to the https://jolokia.org/reference/html/[the jolokia
documentation] to configure it.

The agent can either be attached when you start the application or attached on a running JVM (you would need
special permission to access the process). In the first case, launch you application using:

[source]
----
java -javaagent:/.../agents/jolokia-jvm.jar=port=7777,host=localhost -jar ...
----

The `-javaagent` specifies the path to the jolokia agent jar file. You can configure the port and host from the
command line. Here it registers the REST endpoint on `http://localhost:7777`.

You can also attach the agent on a running JVM with:

[source]
----
java -jar jolokia-jvm.jar start PID
----

Replace `PID` with the process id of the JVM.

Once Jolokia is configured and launched, you can consume the data from Hawtio.

On Hawtio, enter the connection details as follows:

image::../../images/hawtio-connect.png[]

Then, you can go to the _JMX_ tab and you should find a _directory_ with the name you entered as JMX domain
in the Vert.x configuration:

image::../../images/hawtio-jmx.png[]

From this, you can configure your dashboard and retrieve any metric exposed by vert.x.

== Using Jolokia and JMX4Perl to expose metrics to Nagios

http://search.cpan.org/~roland/jmx4perl/scripts/check_jmx4perl[Check_jmx4perl] is a Nagios plugin using jmx4perl for
accessing JMX data remotely. It lets you expose the Vert.x metrics to Nagios.

First you need to start your application with the Jolokia JVM agent attached to it. There are several ways to
attach jolokia. See https://jolokia.org/reference/html/architecture.html[for further details]. Here, we explain how
to use the Jolokia agent with the default configuration. Refer to the https://jolokia.org/reference/html/[the jolokia
documentation] to configure it.

The agent can either be attached when you start the application or attached on a running JVM (you would need
special permission to access the process). In the first case, launch you application using:

[source]
----
java -javaagent:/.../agents/jolokia-jvm.jar=port=7777,host=localhost -jar ...
----

The `-javaagent` specifies the path to the jolokia agent jar file. You can configure the port and host from the
command line. Here it registers the REST endpoint on `http://localhost:7777`.

You can also attach the agent on a running JVM with:

[source]
----
java -jar jolokia-jvm.jar start PID
----

Replace `PID` with the process id of the JVM.

Once Jolokia is started, you can configure your Nagios check such as:

[source]
----
check_jmx4perl --url http://10.0.2.2:8778/jolokia --name eventloops --mbean vertx:name=vertx.event-loop-size
--attribute Value --warning 4
----

Check http://search.cpan.org/~roland/jmx4perl/scripts/check_jmx4perl[check_jmx4perl documentation] to get more
details about check configuration.

== Metrics commands via Telnet or SSH in Vert.x Shell service

To find out the available metrics commands you can use the _help_ builtin command:

* Available commands
.. metrics-ls: List the known metrics for the current Vert.x instance
.. metrics-info: Show metrics info for the current Vert.x instance in JSON format
.. metrics-histogram: Show histogram metrics table for the current Vert.x instance in real time